{% extends "base.html" %}
{% block title %}Dashboard ‚Äî AllDebrid Proxy{% endblock %}
{% block content %}

<style>
/* Hero section */
.hero {
  text-align: center;
  padding: 40px 20px;
  background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,197,94,0.1));
  border-radius: 16px;
  margin-bottom: 30px;
  border: 1px solid var(--border);
}
.hero h1 {
  font-size: clamp(24px, 5vw, 36px);
  margin-bottom: 12px;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.hero p {
  color: var(--muted);
  font-size: 16px;
  max-width: 600px;
  margin: 0 auto;
}

/* Stats Dashboard */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-bottom: 30px;
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
.stat-card:hover {
  border-color: var(--border-light);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}
.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  opacity: 0;
  transition: opacity 0.3s ease;
}
.stat-card:hover::before {
  opacity: 1;
}
.stat-label {
  font-size: 13px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  font-weight: 600;
}
.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
  line-height: 1;
}
.stat-sublabel {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}
.stat-icon {
  font-size: 24px;
  margin-bottom: 8px;
  opacity: 0.8;
}
.stat-trend {
  display: inline-block;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 4px;
  margin-left: 8px;
}
.stat-trend.up {
  background: rgba(34, 197, 94, 0.1);
  color: var(--accent-2);
}
.stat-trend.down {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}
.loading-skeleton {
  background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--card-hover) 50%, var(--bg-secondary) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 8px;
  height: 32px;
  width: 100%;
}
@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.progress-bar-container {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 999px;
  height: 8px;
  overflow: hidden;
  margin-top: 8px;
  position: relative;
}
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  border-radius: 999px;
  transition: width 0.5s ease;
  position: relative;
  overflow: hidden;
}
.progress-bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 2s infinite;
}
@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 500;
  border: 1px solid;
}
.status-indicator.online {
  background: rgba(34, 197, 94, 0.1);
  border-color: rgba(34, 197, 94, 0.3);
  color: var(--accent-2);
}
.status-indicator.offline {
  background: rgba(239, 68, 68, 0.1);
  border-color: rgba(239, 68, 68, 0.3);
  color: var(--danger);
}
.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }
  .stat-card {
    padding: 16px;
  }
  .stat-value {
    font-size: 28px;
  }
  .hero h1 {
    font-size: 24px;
  }
  .hero p {
    font-size: 14px;
  }
}

/* Form styling */
.form-container {
  max-width: 700px;
  margin: 0 auto;
}
.form-group {
  margin-bottom: 20px;
}
.form-hint {
  display: block;
  margin-top: 6px;
  color: var(--muted);
  font-size: 12px;
  line-height: 1.4;
}
.form-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: flex-start;
  flex-wrap: wrap;
  margin-top: 24px;
}
.or-divider {
  text-align: center;
  margin: 20px 0;
  color: var(--muted);
  font-size: 14px;
  position: relative;
}
.or-divider::before,
.or-divider::after {
  content: '';
  position: absolute;
  top: 50%;
  width: calc(50% - 30px);
  height: 1px;
  background: var(--border);
}
.or-divider::before {
  left: 0;
}
.or-divider::after {
  right: 0;
}
.file-upload-area {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  background: var(--bg-secondary);
  cursor: pointer;
  transition: all 0.3s ease;
}
.file-upload-area:hover {
  border-color: var(--accent);
  background: rgba(99, 102, 241, 0.05);
}
.file-upload-area input[type="file"] {
  display: none;
}
.file-upload-label {
  display: block;
  cursor: pointer;
}
.file-upload-icon {
  font-size: 48px;
  margin-bottom: 12px;
}
.file-upload-text {
  color: var(--text);
  font-size: 14px;
  margin-bottom: 6px;
}
.file-upload-hint {
  color: var(--muted);
  font-size: 12px;
}
.info-box {
  background: rgba(99, 102, 241, 0.05);
  border: 1px solid rgba(99, 102, 241, 0.2);
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
}
.info-box h3 {
  font-size: 14px;
  margin: 0 0 8px 0;
  color: var(--accent);
}
.info-box p {
  font-size: 13px;
  color: var(--muted);
  margin: 0;
  line-height: 1.6;
}
.health-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: var(--bg-secondary);
  border-radius: 10px;
  margin-top: 20px;
}
</style>

<div class="hero">
  <h1>üöÄ AllDebrid Proxy Dashboard</h1>
  <p>Monitor your downloads, manage tasks, and track system performance in real-time</p>
</div>

<!-- System Statistics Dashboard -->
<div class="card" style="margin-bottom: 24px;">
  <h2 style="margin-bottom: 16px;">üìä System Statistics</h2>
  
  <div class="stats-grid" id="stats-grid">
    <!-- Active Downloads -->
    <div class="stat-card">
      <div class="stat-icon">‚¨áÔ∏è</div>
      <div class="stat-label">Active Downloads</div>
      <div class="stat-value" id="stat-active-downloads">
        <div class="loading-skeleton"></div>
      </div>
      <div class="stat-sublabel" id="stat-downloading-files">Loading...</div>
    </div>
    
    <!-- Queued Tasks -->
    <div class="stat-card">
      <div class="stat-icon">üìã</div>
      <div class="stat-label">Queued Tasks</div>
      <div class="stat-value" id="stat-queued">
        <div class="loading-skeleton"></div>
      </div>
      <div class="stat-sublabel">Waiting to start</div>
    </div>
    
    <!-- Storage Usage -->
    <div class="stat-card">
      <div class="stat-icon">üíæ</div>
      <div class="stat-label">Storage Available</div>
      <div class="stat-value" id="stat-storage">
        <div class="loading-skeleton"></div>
      </div>
      <div class="stat-sublabel" id="stat-storage-reserved">Loading...</div>
    </div>
    
    <!-- Total Tasks -->
    <div class="stat-card">
      <div class="stat-icon">üì¶</div>
      <div class="stat-label">Total Tasks</div>
      <div class="stat-value" id="stat-total-tasks">
        <div class="loading-skeleton"></div>
      </div>
      <div class="stat-sublabel" id="stat-completed-tasks">Loading...</div>
    </div>
  </div>
  
  <!-- Download Progress -->
  <div id="download-progress-section" style="display: none; margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <span style="font-size: 14px; font-weight: 600; color: var(--text);">
        <span id="progress-label">Overall Download Progress</span>
      </span>
      <span style="font-size: 14px; font-weight: 600; color: var(--accent);" id="progress-percentage">0%</span>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar-fill" id="progress-bar" style="width: 0%"></div>
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--muted);">
      <span id="progress-downloaded">0 B downloaded</span>
      <span id="progress-total">of 0 B total</span>
    </div>
  </div>
  
  <!-- Worker Status -->
  <div style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
    <div class="status-indicator" id="worker-status">
      <span class="status-dot"></span>
      <span>Checking status...</span>
    </div>
    <div style="font-size: 12px; color: var(--muted);" id="last-update">
      Last updated: Never
    </div>
  </div>
</div>

<!-- Task Creation Form -->
<div class="form-container">
  <div class="card">
    <h2>Create New Download Task</h2>
    
    <form method="post" action="{{ url_for('create_task') }}" enctype="multipart/form-data">
      <div class="form-group">
        <label>Upload Torrent File(s)</label>
        <div class="file-upload-area" onclick="document.getElementById('torrent-files').click()">
          <label for="torrent-files" class="file-upload-label">
            <div class="file-upload-icon">üìÅ</div>
            <div class="file-upload-text">Click to select .torrent file(s)</div>
            <div class="file-upload-hint">Max 10MB per file. Multiple files supported.</div>
          </label>
          <input 
            type="file" 
            id="torrent-files" 
            name="torrent_files" 
            accept=".torrent"
            multiple
          />
        </div>
        <small class="form-hint" id="file-count-hint" style="display: none;">
          <span id="file-count">0</span> file(s) selected
        </small>
      </div>

      <div class="or-divider">OR</div>

      <div class="form-group">
        <label for="source">Magnet Link or URL (one per line for multiple)</label>
        <textarea 
          id="source" 
          name="source" 
          placeholder="magnet:?xt=urn:btih:... or https://example.com/file.zip&#10;https://example.com/file2.zip&#10;magnet:?xt=urn:btih:..."
          rows="5"
        ></textarea>
        <small class="form-hint">üí° Paste one or more magnet links or direct URLs (one per line). Supported: HTTP/HTTPS links and magnet links.</small>
      </div>

      <div class="form-group">
        <label for="label">Label (Optional)</label>
        <input 
          type="text" 
          id="label" 
          name="label" 
          placeholder="e.g., Movie Name, TV Show S01E01"
        />
      </div>

      <div class="form-group">
        <label for="mode">Download Mode</label>
        <select id="mode" name="mode">
          <option value="auto">Auto (Download all files automatically)</option>
          <option value="select">Select (Choose specific files manually)</option>
        </select>
      </div>

      <div class="form-actions">
        <button class="btn primary" type="submit">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Create Task
        </button>
        <a class="btn" href="{{ url_for('admin_page') }}">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v20M2 12h20"></path>
          </svg>
          View All Tasks
        </a>
      </div>
    </form>

    <div class="info-box">
      <h3>üí° Smart Task Reuse</h3>
      <p>
        If you submit a magnet link or URL that's already been downloaded, the system will automatically 
        reuse the existing files instead of downloading again. This saves bandwidth and time! You can also
        submit multiple sources at once (one per line) to queue multiple downloads.
      </p>
    </div>
  </div>
</div>

<script>
// Stats update system
let statsUpdateInterval = null;

// Format bytes to human readable format
function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 10) / 10 + ' ' + sizes[i];
}

// Format number with commas
function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Update stats display
async function updateStats() {
  try {
    const response = await fetch('/api/stats');
    if (!response.ok) throw new Error('Failed to fetch stats');
    
    const stats = await response.json();
    
    // Update active downloads
    const activeDownloads = stats.tasks?.downloading || 0;
    const downloadingFiles = stats.files?.downloading || 0;
    document.getElementById('stat-active-downloads').textContent = activeDownloads;
    document.getElementById('stat-downloading-files').textContent = 
      `${downloadingFiles} file${downloadingFiles !== 1 ? 's' : ''} downloading`;
    
    // Update queued tasks
    const queuedTasks = (stats.tasks?.queued || 0) + (stats.tasks?.resolving || 0);
    document.getElementById('stat-queued').textContent = queuedTasks;
    
    // Update storage
    const freeBytes = stats.storage?.free_bytes || 0;
    const reservedBytes = stats.storage?.reserved_bytes || 0;
    document.getElementById('stat-storage').textContent = formatBytes(freeBytes);
    document.getElementById('stat-storage-reserved').textContent = 
      `${formatBytes(reservedBytes)} reserved`;
    
    // Update total tasks
    const totalTasks = stats.tasks?.total || 0;
    const completedTasks = stats.tasks?.completed || 0;
    document.getElementById('stat-total-tasks').textContent = formatNumber(totalTasks);
    document.getElementById('stat-completed-tasks').textContent = 
      `${formatNumber(completedTasks)} completed`;
    
    // Update download progress
    const downloadedBytes = stats.downloads?.downloaded_bytes || 0;
    const totalBytes = stats.downloads?.total_bytes || 0;
    const progressPct = stats.downloads?.progress_pct || 0;
    
    if (downloadingFiles > 0 || downloadedBytes > 0) {
      document.getElementById('download-progress-section').style.display = 'block';
      document.getElementById('progress-bar').style.width = progressPct + '%';
      document.getElementById('progress-percentage').textContent = progressPct + '%';
      document.getElementById('progress-downloaded').textContent = formatBytes(downloadedBytes) + ' downloaded';
      document.getElementById('progress-total').textContent = 'of ' + formatBytes(totalBytes) + ' total';
      
      if (downloadingFiles > 0) {
        document.getElementById('progress-label').textContent = 
          `Downloading ${downloadingFiles} file${downloadingFiles !== 1 ? 's' : ''}`;
      } else {
        document.getElementById('progress-label').textContent = 'Overall Download Progress';
      }
    } else {
      document.getElementById('download-progress-section').style.display = 'none';
    }
    
    // Update worker status
    const workerHealthy = stats.health?.worker_healthy !== false;
    const statusEl = document.getElementById('worker-status');
    if (workerHealthy) {
      statusEl.className = 'status-indicator online';
      statusEl.innerHTML = '<span class="status-dot"></span><span>System Online</span>';
    } else {
      statusEl.className = 'status-indicator offline';
      statusEl.innerHTML = '<span class="status-dot"></span><span>System Offline</span>';
    }
    
    // Update last update time
    const now = new Date();
    document.getElementById('last-update').textContent = 
      `Last updated: ${now.toLocaleTimeString()}`;
    
  } catch (error) {
    console.error('Failed to update stats:', error);
    document.getElementById('worker-status').className = 'status-indicator offline';
    document.getElementById('worker-status').innerHTML = 
      '<span class="status-dot"></span><span>Connection Error</span>';
  }
}

// Start stats updates
function startStatsUpdates() {
  // Initial update
  updateStats();
  
  // Update every 3 seconds
  if (statsUpdateInterval) {
    clearInterval(statsUpdateInterval);
  }
  statsUpdateInterval = setInterval(updateStats, 3000);
}

// Stop stats updates
function stopStatsUpdates() {
  if (statsUpdateInterval) {
    clearInterval(statsUpdateInterval);
    statsUpdateInterval = null;
  }
}

// Start updates when page loads
document.addEventListener('DOMContentLoaded', startStatsUpdates);

// Stop updates when page is hidden (save resources)
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    stopStatsUpdates();
  } else {
    startStatsUpdates();
  }
});

// Update file count when torrent files are selected
document.getElementById('torrent-files').addEventListener('change', function(e) {
  const fileCount = e.target.files.length;
  const hint = document.getElementById('file-count-hint');
  const countSpan = document.getElementById('file-count');
  
  if (fileCount > 0) {
    countSpan.textContent = fileCount;
    hint.style.display = 'block';
    
    // Update the upload area text
    const uploadText = document.querySelector('.file-upload-text');
    if (fileCount === 1) {
      uploadText.textContent = e.target.files[0].name;
    } else {
      uploadText.textContent = `${fileCount} torrent files selected`;
    }
  } else {
    hint.style.display = 'none';
    document.querySelector('.file-upload-text').textContent = 'Click to select .torrent file(s)';
  }
});

// Prevent form submission if no files and no source text
document.querySelector('form').addEventListener('submit', function(e) {
  const files = document.getElementById('torrent-files').files;
  const source = document.getElementById('source').value.trim();
  
  if (files.length === 0 && !source) {
    e.preventDefault();
    alert('Please either upload torrent file(s) or enter magnet link(s)/URL(s)');
    return false;
  }
});
</script>

{% endblock %}
