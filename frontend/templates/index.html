{% extends "base.html" %}
{% block title %}Create Task ‚Äî AllDebrid Proxy{% endblock %}
{% block content %}

<style>
/* Hero section */
.hero {
  text-align: center;
  padding: 40px 20px;
  background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,197,94,0.1));
  border-radius: 16px;
  margin-bottom: 30px;
  border: 1px solid var(--border);
}
.hero h1 {
  font-size: clamp(24px, 5vw, 36px);
  margin-bottom: 12px;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.hero p {
  color: var(--muted);
  font-size: 16px;
  max-width: 600px;
  margin: 0 auto;
}

/* Form styling */
.form-container {
  max-width: 700px;
  margin: 0 auto;
}
.form-group {
  margin-bottom: 20px;
}
.form-hint {
  display: block;
  margin-top: 6px;
  color: var(--muted);
  font-size: 12px;
  line-height: 1.4;
}
.form-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: flex-start;
  flex-wrap: wrap;
  margin-top: 24px;
}
.or-divider {
  text-align: center;
  margin: 20px 0;
  color: var(--muted);
  font-size: 14px;
  position: relative;
}
.or-divider::before,
.or-divider::after {
  content: '';
  position: absolute;
  top: 50%;
  width: calc(50% - 30px);
  height: 1px;
  background: var(--border);
}
.or-divider::before {
  left: 0;
}
.or-divider::after {
  right: 0;
}
.file-upload-area {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  background: var(--bg-secondary);
  cursor: pointer;
  transition: all 0.3s ease;
}
.file-upload-area:hover {
  border-color: var(--accent);
  background: rgba(99, 102, 241, 0.05);
}
.file-upload-area input[type="file"] {
  display: none;
}
.file-upload-label {
  display: block;
  cursor: pointer;
}
.file-upload-icon {
  font-size: 48px;
  margin-bottom: 12px;
}
.file-upload-text {
  color: var(--text);
  font-size: 14px;
  margin-bottom: 6px;
}
.file-upload-hint {
  color: var(--muted);
  font-size: 12px;
}
.info-box {
  background: rgba(99, 102, 241, 0.05);
  border: 1px solid rgba(99, 102, 241, 0.2);
  border-radius: 12px;
  padding: 16px;
  margin-top: 20px;
}
.info-box h3 {
  font-size: 14px;
  margin: 0 0 8px 0;
  color: var(--accent);
}
.info-box p {
  font-size: 13px;
  color: var(--muted);
  margin: 0;
  line-height: 1.6;
}
.health-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: var(--bg-secondary);
  border-radius: 10px;
  margin-top: 20px;
}
</style>

<div class="hero">
  <h1>üöÄ Create Download Task</h1>
  <p>Upload a torrent file, paste a magnet link, or direct URL, and let the worker handle the rest</p>
</div>

<div class="form-container">
  <div class="card">
    <h2>New Download Task</h2>
    
    <form method="post" action="{{ url_for('create_task') }}" enctype="multipart/form-data">
      <div class="form-group">
        <label>Upload Torrent File(s)</label>
        <div class="file-upload-area" onclick="document.getElementById('torrent-files').click()">
          <label for="torrent-files" class="file-upload-label">
            <div class="file-upload-icon">üìÅ</div>
            <div class="file-upload-text">Click to select .torrent file(s)</div>
            <div class="file-upload-hint">Max 10MB per file. Multiple files supported.</div>
          </label>
          <input 
            type="file" 
            id="torrent-files" 
            name="torrent_files" 
            accept=".torrent"
            multiple
          />
        </div>
        <small class="form-hint" id="file-count-hint" style="display: none;">
          <span id="file-count">0</span> file(s) selected
        </small>
      </div>

      <div class="or-divider">OR</div>

      <div class="form-group">
        <label for="source">Magnet Link or URL (one per line for multiple)</label>
        <textarea 
          id="source" 
          name="source" 
          placeholder="magnet:?xt=urn:btih:... or https://example.com/file.zip&#10;https://example.com/file2.zip&#10;magnet:?xt=urn:btih:..."
          rows="5"
        ></textarea>
        <small class="form-hint">üí° Paste one or more magnet links or direct URLs (one per line). Supported: HTTP/HTTPS links and magnet links.</small>
      </div>

      <div class="form-group">
        <label for="label">Label (Optional)</label>
        <input 
          type="text" 
          id="label" 
          name="label" 
          placeholder="e.g., Movie Name, TV Show S01E01"
        />
      </div>

      <div class="form-group">
        <label for="mode">Download Mode</label>
        <select id="mode" name="mode">
          <option value="auto">Auto (Download all files automatically)</option>
          <option value="select">Select (Choose specific files manually)</option>
        </select>
      </div>

      <div class="form-actions">
        <button class="btn primary" type="submit">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Create Task
        </button>
        <a class="btn" href="{{ url_for('admin_page') }}">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v20M2 12h20"></path>
          </svg>
          View All Tasks
        </a>
      </div>
    </form>

    <div class="info-box">
      <h3>üí° Smart Task Reuse</h3>
      <p>
        If you submit a magnet link or URL that's already been downloaded, the system will automatically 
        reuse the existing files instead of downloading again. This saves bandwidth and time! You can also
        submit multiple sources at once (one per line) to queue multiple downloads.
      </p>
    </div>

    {% if health %}
    <div class="health-status">
      {% set is_ok = health.get('ok') %}
      <span class="pill {{ 'good' if is_ok else 'bad' }}">
        {{ '‚óè' if is_ok else '‚óã' }} Worker {{ 'Online' if is_ok else 'Offline' }}
      </span>
      {% if not is_ok %}
        <span class="small muted">{{ health.get('error', 'Unknown error') }}</span>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<script>
// Update file count when torrent files are selected
document.getElementById('torrent-files').addEventListener('change', function(e) {
  const fileCount = e.target.files.length;
  const hint = document.getElementById('file-count-hint');
  const countSpan = document.getElementById('file-count');
  
  if (fileCount > 0) {
    countSpan.textContent = fileCount;
    hint.style.display = 'block';
    
    // Update the upload area text
    const uploadText = document.querySelector('.file-upload-text');
    if (fileCount === 1) {
      uploadText.textContent = e.target.files[0].name;
    } else {
      uploadText.textContent = `${fileCount} torrent files selected`;
    }
  } else {
    hint.style.display = 'none';
    document.querySelector('.file-upload-text').textContent = 'Click to select .torrent file(s)';
  }
});

// Prevent form submission if no files and no source text
document.querySelector('form').addEventListener('submit', function(e) {
  const files = document.getElementById('torrent-files').files;
  const source = document.getElementById('source').value.trim();
  
  if (files.length === 0 && !source) {
    e.preventDefault();
    alert('Please either upload torrent file(s) or enter magnet link(s)/URL(s)');
    return false;
  }
});
</script>

{% endblock %}
