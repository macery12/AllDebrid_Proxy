{% extends "base.html" %}
{% block title %}Dashboard - AllDebrid Proxy{% endblock %}
{% block content %}

<style>
/* ===== MODERN DASHBOARD DESIGN ===== */

/* Gradient Header */
.page-header {
  background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 50%, #ec4899 100%);
  border-radius: 24px;
  padding: 56px 40px;
  margin-bottom: 40px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4);
}
.page-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -10%;
  width: 350px;
  height: 350px;
  background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
  border-radius: 50%;
  animation: float 6s ease-in-out infinite;
}
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}
.page-title {
  font-size: clamp(32px, 7vw, 48px);
  font-weight: 900;
  color: #fff;
  margin: 0 0 16px 0;
  text-shadow: 0 4px 20px rgba(0,0,0,0.4);
  position: relative;
  z-index: 1;
  letter-spacing: -0.5px;
}
.page-subtitle {
  font-size: clamp(16px, 3vw, 20px);
  color: rgba(255,255,255,0.95);
  margin: 0;
  position: relative;
  z-index: 1;
  font-weight: 500;
}

/* Quick Nav */
.quick-nav {
  display: flex;
  gap: 16px;
  margin-bottom: 40px;
  flex-wrap: wrap;
}
.nav-btn {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 14px 24px;
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: 14px;
  color: var(--text);
  text-decoration: none;
  font-weight: 700;
  font-size: 15px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  cursor: pointer;
}
.nav-btn:hover {
  border-color: var(--accent);
  background: var(--card-hover);
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(99, 102, 241, 0.3);
}
.nav-btn.primary {
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  border-color: var(--accent);
  color: #fff;
}

/* Stats Section */
.stats-section {
  margin-bottom: 40px;
}
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}
.section-title {
  font-size: 24px;
  font-weight: 800;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 12px;
  letter-spacing: -0.5px;
}
.live-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: rgba(34, 197, 94, 0.15);
  border: 2px solid rgba(34, 197, 94, 0.4);
  border-radius: 20px;
  font-size: 12px;
  font-weight: 800;
  color: var(--accent-2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.live-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent-2);
  box-shadow: 0 0 12px var(--accent-2);
  animation: pulse 2s infinite;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}
.stat-box {
  background: linear-gradient(135deg, var(--card) 0%, rgba(20, 27, 46, 0.8) 100%);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 28px;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}
.stat-box::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  opacity: 0;
  transition: opacity 0.3s ease;
}
.stat-box:hover::before {
  opacity: 1;
}
.stat-box:hover {
  border-color: var(--accent);
  transform: translateY(-6px);
  box-shadow: 0 16px 40px rgba(99, 102, 241, 0.3);
}
.stat-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
}
.stat-emoji {
  font-size: 40px;
  line-height: 1;
  filter: drop-shadow(0 4px 12px rgba(99, 102, 241, 0.4));
}
.stat-tag {
  padding: 6px 12px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  border: 2px solid;
}
.stat-tag.live {
  background: rgba(34, 197, 94, 0.2);
  color: var(--accent-2);
  border-color: rgba(34, 197, 94, 0.4);
}
.stat-tag.pending {
  background: rgba(245, 158, 11, 0.2);
  color: var(--warn);
  border-color: rgba(245, 158, 11, 0.4);
}
.stat-tag.info {
  background: rgba(99, 102, 241, 0.2);
  color: var(--accent);
  border-color: rgba(99, 102, 241, 0.4);
}
.stat-label {
  font-size: 13px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1.2px;
  margin-bottom: 12px;
  font-weight: 800;
}
.stat-number {
  font-size: 42px;
  font-weight: 900;
  color: var(--text);
  margin-bottom: 10px;
  line-height: 1;
  letter-spacing: -1px;
}
.stat-desc {
  font-size: 14px;
  color: var(--muted);
  line-height: 1.6;
  font-weight: 500;
}
.skeleton {
  background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--card-hover) 50%, var(--bg-secondary) 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
  border-radius: 10px;
  height: 42px;
  width: 100%;
}
@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Progress Card */
.progress-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 32px;
  margin-bottom: 32px;
}
.progress-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.progress-label {
  font-size: 17px;
  font-weight: 800;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}
.progress-percent {
  font-size: 32px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.progress-track {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 14px;
  height: 14px;
  overflow: hidden;
  position: relative;
  box-shadow: inset 0 2px 6px rgba(0,0,0,0.3);
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #8b5cf6, #6366f1, #22c55e);
  background-size: 200% 100%;
  border-radius: 14px;
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  box-shadow: 0 0 24px rgba(99, 102, 241, 0.6);
  animation: progress-glow 3s ease-in-out infinite;
}
@keyframes progress-glow {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}
.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
  animation: shimmer 2.5s infinite;
}
@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
.progress-info {
  display: flex;
  justify-content: space-between;
  margin-top: 14px;
  font-size: 14px;
  color: var(--muted);
  font-weight: 700;
}

/* Status Bar */
.status-bar {
  display: flex;
  gap: 20px;
  align-items: center;
  flex-wrap: wrap;
}
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 12px 22px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 800;
  border: 2px solid;
  transition: all 0.3s ease;
}
.status-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 24px rgba(0,0,0,0.2);
}
.status-badge.online {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2));
  border-color: rgba(34, 197, 94, 0.6);
  color: var(--accent-2);
}
.status-badge.offline {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
  border-color: rgba(239, 68, 68, 0.6);
  color: var(--danger);
}
.status-pulse {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: currentColor;
  box-shadow: 0 0 16px currentColor;
  animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(0.85); }
}

/* Task Form */
.task-form {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 40px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.25);
}
.form-header {
  margin-bottom: 32px;
}
.form-title {
  font-size: 26px;
  font-weight: 900;
  color: var(--text);
  margin: 0 0 10px 0;
  letter-spacing: -0.5px;
}
.form-subtitle {
  font-size: 15px;
  color: var(--muted);
  margin: 0;
  font-weight: 500;
}
.form-field {
  margin-bottom: 28px;
}
.field-label {
  display: block;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 12px;
  font-size: 15px;
  letter-spacing: 0.3px;
}
.field-hint {
  display: block;
  margin-top: 10px;
  color: var(--muted);
  font-size: 13px;
  line-height: 1.7;
  font-weight: 500;
}
.upload-zone {
  border: 3px dashed var(--border);
  border-radius: 18px;
  padding: 40px;
  text-align: center;
  background: var(--bg-secondary);
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}
.upload-zone:hover {
  border-color: var(--accent);
  background: rgba(99, 102, 241, 0.1);
  border-style: solid;
}
.upload-zone input[type="file"] {
  display: none;
}
.upload-emoji {
  font-size: 64px;
  margin-bottom: 18px;
  filter: drop-shadow(0 6px 16px rgba(99, 102, 241, 0.4));
}
.upload-text {
  color: var(--text);
  font-size: 18px;
  font-weight: 800;
  margin-bottom: 10px;
}
.upload-hint {
  color: var(--muted);
  font-size: 14px;
  font-weight: 500;
}
.divider {
  text-align: center;
  margin: 32px 0;
  color: var(--muted);
  font-size: 15px;
  font-weight: 800;
  position: relative;
}
.divider::before,
.divider::after {
  content: '';
  position: absolute;
  top: 50%;
  width: calc(50% - 50px);
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--border), transparent);
}
.divider::before {
  left: 0;
}
.divider::after {
  right: 0;
}
.form-buttons {
  display: flex;
  gap: 14px;
  margin-top: 36px;
  flex-wrap: wrap;
}
.tip-box {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(124, 58, 237, 0.1));
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 16px;
  padding: 22px 26px;
  margin-top: 28px;
  display: flex;
  gap: 14px;
}
.tip-emoji {
  font-size: 28px;
  flex-shrink: 0;
}
.tip-content {
  flex: 1;
}
.tip-title {
  font-size: 15px;
  margin: 0 0 8px 0;
  color: var(--accent);
  font-weight: 800;
}
.tip-text {
  font-size: 14px;
  color: var(--muted);
  margin: 0;
  line-height: 1.7;
  font-weight: 500;
}

/* Responsive */
@media (max-width: 768px) {
  .page-header {
    padding: 40px 24px;
  }
  .page-title {
    font-size: 32px;
  }
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  .stat-box {
    padding: 24px;
  }
  .stat-number {
    font-size: 36px;
  }
  .quick-nav {
    flex-direction: column;
  }
  .nav-btn {
    width: 100%;
    justify-content: center;
  }
  .task-form {
    padding: 28px 24px;
  }
}
</style>

<div class="page-header">
  <h1 class="page-title">üöÄ AllDebrid Proxy</h1>
  <p class="page-subtitle">Manage your downloads with real-time monitoring and analytics</p>
</div>

<div class="quick-nav">
  <a href="{{ url_for('admin_page') }}" class="nav-btn">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <path d="M9 3v18M15 3v18M3 9h18M3 15h18"/>
    </svg>
    All Tasks
  </a>
  <a href="{{ url_for('admin_users_page') }}" class="nav-btn">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
      <circle cx="9" cy="7" r="4"/>
      <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
    </svg>
    Users
  </a>
</div>

<div class="stats-section">
  <div class="section-header">
    <h2 class="section-title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <line x1="12" y1="20" x2="12" y2="10"/>
        <line x1="18" y1="20" x2="18" y2="4"/>
        <line x1="6" y1="20" x2="6" y2="16"/>
      </svg>
      System Analytics
    </h2>
    <div class="live-badge">
      <span class="live-dot"></span>
      <span id="refresh-time">LIVE</span>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-box">
      <div class="stat-top">
        <div class="stat-emoji">‚¨áÔ∏è</div>
        <div class="stat-tag live">ACTIVE</div>
      </div>
      <div class="stat-label">Active Downloads</div>
      <div class="stat-number" id="active-count">
        <div class="skeleton"></div>
      </div>
      <div class="stat-desc" id="active-desc">Loading...</div>
    </div>

    <div class="stat-box">
      <div class="stat-top">
        <div class="stat-emoji">üìã</div>
        <div class="stat-tag pending">PENDING</div>
      </div>
      <div class="stat-label">Queued Tasks</div>
      <div class="stat-number" id="queue-count">
        <div class="skeleton"></div>
      </div>
      <div class="stat-desc">Waiting to start</div>
    </div>

    <div class="stat-box">
      <div class="stat-top">
        <div class="stat-emoji">üíæ</div>
        <div class="stat-tag info">STORAGE</div>
      </div>
      <div class="stat-label">Free Space</div>
      <div class="stat-number" id="storage-free">
        <div class="skeleton"></div>
      </div>
      <div class="stat-desc" id="storage-desc">Loading...</div>
    </div>

    <div class="stat-box">
      <div class="stat-top">
        <div class="stat-emoji">üì¶</div>
        <div class="stat-tag info">TOTAL</div>
      </div>
      <div class="stat-label">All Tasks</div>
      <div class="stat-number" id="total-count">
        <div class="skeleton"></div>
      </div>
      <div class="stat-desc" id="total-desc">Loading...</div>
    </div>
  </div>

  <div class="progress-card" id="progress-card" style="display: none;">
    <div class="progress-top">
      <div class="progress-label">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        <span id="progress-title">Download Progress</span>
      </div>
      <div class="progress-percent" id="progress-pct">0%</div>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
    </div>
    <div class="progress-info">
      <span id="progress-down">0 B downloaded</span>
      <span id="progress-total">of 0 B total</span>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-badge" id="system-status">
      <span class="status-pulse"></span>
      <span>Checking...</span>
    </div>
    <div style="font-size: 13px; color: var(--muted); font-weight: 700;" id="update-info">
      Initializing...
    </div>
  </div>
</div>

<div class="task-form">
  <div class="form-header">
    <h2 class="form-title">Create Download Task</h2>
    <p class="form-subtitle">Upload torrents, paste magnet links, or add direct URLs</p>
  </div>

  <form method="post" action="{{ url_for('create_task') }}" enctype="multipart/form-data">
    <div class="form-field">
      <label class="field-label">Upload Torrent File(s)</label>
      <div class="upload-zone" onclick="document.getElementById('torrent-files').click()">
        <label for="torrent-files" style="cursor: pointer;">
          <div class="upload-emoji">üìÅ</div>
          <div class="upload-text">Click to select .torrent file(s)</div>
          <div class="upload-hint">Max 10MB per file ‚Ä¢ Multiple files supported</div>
        </label>
        <input 
          type="file" 
          id="torrent-files" 
          name="torrent_files" 
          accept=".torrent"
          multiple
        />
      </div>
      <small class="field-hint" id="file-hint" style="display: none;">
        <span id="file-count">0</span> file(s) selected
      </small>
    </div>

    <div class="divider">OR</div>

    <div class="form-field">
      <label for="source" class="field-label">Magnet Links or URLs</label>
      <textarea 
        id="source" 
        name="source" 
        placeholder="magnet:?xt=urn:btih:... or https://example.com/file.zip&#10;Paste one link per line for multiple sources"
        rows="6"
      ></textarea>
      <small class="field-hint">üí° Paste one or more magnet links or direct URLs (one per line)</small>
    </div>

    <div class="form-field">
      <label for="label" class="field-label">Label (Optional)</label>
      <input 
        type="text" 
        id="label" 
        name="label" 
        placeholder="e.g., Movie Name, TV Show S01E01"
      />
    </div>

    <div class="form-field">
      <label for="mode" class="field-label">Download Mode</label>
      <select id="mode" name="mode">
        <option value="auto">Auto - Download all files automatically</option>
        <option value="select">Select - Choose specific files manually</option>
      </select>
    </div>

    <div class="form-buttons">
      <button class="btn primary" type="submit">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Create Task
      </button>
      <a class="btn" href="{{ url_for('admin_page') }}">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
        </svg>
        View Tasks
      </a>
    </div>
  </form>

  <div class="tip-box">
    <div class="tip-emoji">üí°</div>
    <div class="tip-content">
      <h3 class="tip-title">Smart Task Reuse</h3>
      <p class="tip-text">
        Already downloaded something? The system automatically reuses existing files instead of downloading again, 
        saving bandwidth and time. Submit multiple sources at once (one per line) to queue multiple downloads.
      </p>
    </div>
  </div>
</div>

<script>
// Stats Management
let updateTimer = null;

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 10) / 10 + ' ' + sizes[i];
}

function formatNum(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

async function refreshStats() {
  try {
    const res = await fetch('/api/stats');
    if (!res.ok) throw new Error('Stats request failed');
    
    const stats = await res.json();
    
    // Active downloads
    const activeTasks = stats.tasks?.downloading || 0;
    const activeFiles = stats.files?.downloading || 0;
    document.getElementById('active-count').textContent = activeTasks;
    document.getElementById('active-desc').textContent = 
      `${activeFiles} file${activeFiles !== 1 ? 's' : ''} downloading`;
    
    // Queue
    const queued = (stats.tasks?.queued || 0) + (stats.tasks?.resolving || 0);
    document.getElementById('queue-count').textContent = queued;
    
    // Storage
    const freeSpace = stats.storage?.free_bytes || 0;
    const reserved = stats.storage?.reserved_bytes || 0;
    document.getElementById('storage-free').textContent = formatBytes(freeSpace);
    document.getElementById('storage-desc').textContent = 
      `${formatBytes(reserved)} reserved`;
    
    // Total tasks
    const total = stats.tasks?.total || 0;
    const completed = stats.tasks?.completed || 0;
    document.getElementById('total-count').textContent = formatNum(total);
    document.getElementById('total-desc').textContent = 
      `${formatNum(completed)} completed`;
    
    // Progress
    const downloaded = stats.downloads?.downloaded_bytes || 0;
    const totalBytes = stats.downloads?.total_bytes || 0;
    const pct = stats.downloads?.progress_pct || 0;
    
    if (activeFiles > 0 || downloaded > 0) {
      document.getElementById('progress-card').style.display = 'block';
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('progress-pct').textContent = pct + '%';
      document.getElementById('progress-down').textContent = formatBytes(downloaded) + ' downloaded';
      document.getElementById('progress-total').textContent = 'of ' + formatBytes(totalBytes) + ' total';
      document.getElementById('progress-title').textContent = 
        activeFiles > 0 ? `Downloading ${activeFiles} file${activeFiles !== 1 ? 's' : ''}` : 'Download Progress';
    } else {
      document.getElementById('progress-card').style.display = 'none';
    }
    
    // System status
    const healthy = stats.health?.worker_healthy !== false;
    const statusEl = document.getElementById('system-status');
    if (healthy) {
      statusEl.className = 'status-badge online';
      statusEl.innerHTML = '<span class="status-pulse"></span><span>System Online</span>';
    } else {
      statusEl.className = 'status-badge offline';
      statusEl.innerHTML = '<span class="status-pulse"></span><span>System Offline</span>';
    }
    
    // Update time
    const now = new Date();
    document.getElementById('update-info').textContent = 
      `Updated ${now.toLocaleTimeString()}`;
    document.getElementById('refresh-time').textContent = 'LIVE';
    
  } catch (err) {
    console.error('Stats update failed:', err);
    const statusEl = document.getElementById('system-status');
    statusEl.className = 'status-badge offline';
    statusEl.innerHTML = '<span class="status-pulse"></span><span>Connection Error</span>';
  }
}

function startUpdates() {
  refreshStats();
  if (updateTimer) clearInterval(updateTimer);
  updateTimer = setInterval(refreshStats, 3000);
}

function stopUpdates() {
  if (updateTimer) {
    clearInterval(updateTimer);
    updateTimer = null;
  }
}

// Start on load
document.addEventListener('DOMContentLoaded', startUpdates);

// Pause when hidden
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    stopUpdates();
  } else {
    startUpdates();
  }
});

// File upload handler
document.getElementById('torrent-files').addEventListener('change', function(e) {
  const count = e.target.files.length;
  const hint = document.getElementById('file-hint');
  const countSpan = document.getElementById('file-count');
  
  if (count > 0) {
    countSpan.textContent = count;
    hint.style.display = 'block';
    
    const uploadText = document.querySelector('.upload-text');
    if (count === 1) {
      uploadText.textContent = e.target.files[0].name;
    } else {
      uploadText.textContent = `${count} torrent files selected`;
    }
  } else {
    hint.style.display = 'none';
    document.querySelector('.upload-text').textContent = 'Click to select .torrent file(s)';
  }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
  const files = document.getElementById('torrent-files').files;
  const source = document.getElementById('source').value.trim();
  
  if (files.length === 0 && !source) {
    e.preventDefault();
    alert('Please either upload torrent file(s) or enter magnet link(s)/URL(s)');
    return false;
  }
});
</script>

{% endblock %}
