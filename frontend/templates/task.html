{% extends "base.html" %}
{% block title %}Task {{ task_id }} â€” AllDebrid Proxy{% endblock %}

{% block head %}
<style>
.task-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 12px;
}
.task-header h1 {
  font-size: 24px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}
.task-id-badge {
  font-family: monospace;
  font-size: 14px;
  color: var(--muted);
  background: var(--bg-secondary);
  padding: 4px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
}
.task-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin: 16px 0;
}
.task-meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: var(--muted);
}
.files-section {
  margin-top: 24px;
}
.files-section h2 {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.file-count {
  font-size: 14px;
  color: var(--muted);
  font-weight: normal;
}
.file-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}
.file-table thead th {
  background: var(--bg-secondary);
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
}
.file-table tbody td {
  padding: 12px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}
.file-table tbody tr:hover {
  background: var(--card-hover);
}
.file-table tbody tr:last-child td {
  border-bottom: none;
}
.checkbox-cell {
  width: 50px;
  text-align: center;
}
.checkbox-cell input[type="checkbox"] {
  appearance: none;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-radius: 6px;
  background: var(--bg-secondary);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}
.checkbox-cell input[type="checkbox"]:hover {
  border-color: var(--accent);
}
.checkbox-cell input[type="checkbox"]:checked {
  background: var(--accent);
  border-color: var(--accent);
}
.checkbox-cell input[type="checkbox"]:checked::after {
  content: 'âœ“';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 14px;
  font-weight: bold;
}
.file-table tbody tr:has(input[type="checkbox"]:checked) {
  background: rgba(99, 102, 241, 0.05);
}
.file-name {
  font-weight: 500;
}
.file-path {
  font-size: 12px;
  color: var(--muted);
  font-family: monospace;
  margin-top: 4px;
}
.actions-toolbar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
}
.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
{% macro status_class(text) -%}
  {%- set s = (text or '')|lower -%}
  {%- if 'cancel' in s or 'canceled' in s or 'cancelled' in s
        or 'fail' in s or 'failed' in s
        or 'error' in s or 'abort' in s or 'aborted' in s
        or 'stop' in s or 'stopped' in s or 'timeout' in s -%}
    bad
  {%- elif 'done' in s or 'complete' in s or 'completed' in s
        or 'ready' in s or 'finished' in s or 'success' in s
        or 'downloaded' in s -%}
    good
  {%- elif 'listed' in s -%}
    neutral
  {%- elif 'download' in s or 'fetch' in s or 'queued' in s or 'queue' in s
        or 'wait' in s or 'prepar' in s or 'process' in s
        or 'start' in s or 'run' in s -%}
    warn
  {%- else -%}
    neutral
  {%- endif -%}
{%- endmacro %}

<div class="task-header">
  <div>
    <h1>
      ðŸ“¦ Task Details
    </h1>
    <span class="task-id-badge">{{ task_id }}</span>
  </div>
  <a class="btn primary" href="{{ url_for('index') }}">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
    </svg>
    Home
  </a>
</div>

{% if not t %}
  <div class="card">
    <div class="empty-state">
      <div class="loading-spinner"></div>
      <p style="margin-top: 12px;">Loading task data...</p>
    </div>
  </div>
{% else %}
  <div class="card">
    <h2>Task Information</h2>
    <div class="task-meta">
      <div class="task-meta-item">
        <strong>Status:</strong>
        <span class="pill {{ status_class(t.status) }}" data-task-status>{{ t.status }}</span>
      </div>
      {% if t.label %}
      <div class="task-meta-item">
        <strong>Label:</strong>
        <span>{{ t.label }}</span>
      </div>
      {% endif %}
      {% if t.mode %}
      <div class="task-meta-item">
        <strong>Mode:</strong>
        <span>{{ t.mode }}</span>
      </div>
      {% endif %}
      {% if t.infohash %}
      <div class="task-meta-item">
        <strong>Infohash:</strong>
        <code class="kbd">{{ t.infohash[:16] }}...</code>
      </div>
      {% endif %}
    </div>
  </div>

  {% set final_states = ['ready','failed','canceled','cancelled','deleted','done','completed','error'] %}
  {% set is_final = (t.status or '')|lower in final_states %}
  {% set mode = request.args.get('mode', 'auto') %}

  <div class="card files-section">
    <h2>
      Files
      <span class="file-count" data-file-count>({{ t.files|length }} files)</span>
    </h2>

    {% if (mode == 'select') and not is_final %}
    <form method="post" action="{{ url_for('task_select', task_id=task_id, mode=mode) }}" id="select-form">
    {% endif %}

      <table class="file-table">
        <thead>
          <tr>
            {% if (mode == 'select') and not is_final %}
              <th class="checkbox-cell">
                <input id="masterCheck" type="checkbox" aria-label="Select all" title="Select all">
              </th>
            {% endif %}
            <th>File Name</th>
            <th style="width: 140px; text-align: right;">Size</th>
            <th style="width: 140px;">State</th>
          </tr>
        </thead>
        <tbody data-files-table>
          {% if t.files|length == 0 %}
            <tr data-empty-row>
              {% if (mode == 'select') and not is_final %}<td></td>{% endif %}
              <td colspan="3" class="empty-state">
                <div class="loading-spinner"></div>
                <span style="margin-left: 8px;">Waiting for file list...</span>
              </td>
            </tr>
          {% else %}
            {% for f in t.files %}
              {% set size_bytes = f.size or f.totalSize or f.fileSize or f.bytes or 0 %}
              <tr data-file-id="{{ f.fileId }}">
                {% if (mode == 'select') and not is_final %}
                  <td class="checkbox-cell">
                    <input type="checkbox" name="fileIds" value="{{ f.fileId }}">
                  </td>
                {% endif %}
                <td>
                  <div class="file-name">{{ f.name or f.filename or f.path or f.fileId }}</div>
                  {% if f.localPath %}
                    <div class="file-path">{{ f.localPath }}</div>
                  {% endif %}
                </td>
                <td style="text-align: right; color: var(--muted);">
                  {{ size_bytes|hbytes }}
                </td>
                <td>
                  <span class="pill {{ status_class(f.state) }}">{{ f.state or 'â€”' }}</span>
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>

      <div class="actions-toolbar">
        {% if (mode == 'select') and not is_final %}
          <button class="btn" type="button" id="btnSelectAll">Select All</button>
          <button class="btn" type="button" id="btnClearAll">Clear All</button>
          <button class="btn primary" type="submit">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Submit Selection
          </button>
        {% endif %}

        {% if (mode == 'select') and not is_final %}
        </form>
        {% endif %}

        <form method="post" action="{{ url_for('task_cancel', task_id=task_id, mode=mode) }}" style="display: inline;">
          <button class="btn warn" type="submit">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            Cancel Task
          </button>
        </form>
        
        <form method="post" action="{{ url_for('task_delete', task_id=task_id, mode=mode) }}" style="display: inline;">
          <input type="hidden" name="purge_files" value="true">
          <button class="btn danger" type="submit">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete + Purge
          </button>
        </form>
        
        <a class="btn good" href="{{ url_for('list_folder', task_id=task_id) }}" target="_blank">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          Open Files
        </a>
      </div>
  </div>
{% endif %}

<script>
(function () {
  // Using tojson filter for safe JSON encoding of server variables
  // tojson automatically escapes special characters to prevent XSS
  const taskId = {{ task_id|tojson }};
  const workerBaseUrl = {{ worker_base_url|tojson }};
  if (!('EventSource' in window)) return;

  // Validate and encode URL components to prevent SSRF
  if (!workerBaseUrl || typeof workerBaseUrl !== 'string') {
    console.error('Invalid worker base URL');
    return;
  }
  
  const es = new EventSource(`${workerBaseUrl}/api/tasks/${encodeURIComponent(taskId)}/events`);
  const statusPill = document.querySelector('[data-task-status]');
  const filesBody = document.querySelector('[data-files-table]');
  const fileCount = document.querySelector('[data-file-count]');
  const isSelectMode = new URLSearchParams(location.search).get('mode') === 'select';
  const fileMap = new Map();

  function statusClass(text) {
    const s = (text || '').toLowerCase();
    if (s.includes('cancel') || s.includes('fail') || s.includes('error') || s.includes('abort') || s.includes('stop') || s.includes('timeout')) return 'pill bad';
    if (s.includes('done') || s.includes('complete') || s.includes('ready') || s.includes('finish') || s.includes('success') || s.includes('downloaded')) return 'pill good';
    if (s.includes('listed')) return 'pill neutral';
    return 'pill warn';
  }

  function formatBytes(n) {
    n = Number(n || 0);
    const u = ["B","KB","MB","GB","TB"];
    let i = 0;
    while (n >= 1024 && i < u.length - 1) {
      n /= 1024;
      i++;
    }
    return (i === 0 ? Math.round(n) : n.toFixed(1)) + " " + u[i];
  }

  function removeEmptyRow() {
    const empty = filesBody && filesBody.querySelector('[data-empty-row]');
    if (empty) empty.remove();
  }

  function upsertRow(f) {
    if (!filesBody) return;
    const id = f.fileId || f.id || f.name;
    if (!id) return;

    removeEmptyRow();

    const merged = Object.assign({}, fileMap.get(id) || {}, f, { fileId: id });
    fileMap.set(id, merged);

    let tr = filesBody.querySelector(`tr[data-file-id="${CSS.escape(id)}"]`);
    if (!tr) {
      tr = document.createElement('tr');
      tr.setAttribute('data-file-id', id);
      tr.innerHTML = isSelectMode
        ? `<td class="checkbox-cell"><input type="checkbox" name="fileIds" value="${id}"></td>
           <td><div class="file-name"></div></td>
           <td style="text-align: right; color: var(--muted);"></td>
           <td><span class="pill">â€”</span></td>`
        : `<td><div class="file-name"></div></td>
           <td style="text-align: right; color: var(--muted);"></td>
           <td><span class="pill">â€”</span></td>`;
      filesBody.appendChild(tr);
    }

    const nameDiv = tr.querySelector('.file-name');
    const sizeCell = tr.querySelectorAll('td')[isSelectMode ? 2 : 1];
    const pill = tr.querySelector('.pill');

    if (nameDiv) {
      nameDiv.textContent = merged.name || id;
      if (merged.localPath) {
        let pathDiv = nameDiv.nextElementSibling;
        if (!pathDiv || !pathDiv.classList.contains('file-path')) {
          pathDiv = document.createElement('div');
          pathDiv.className = 'file-path';
          nameDiv.parentNode.appendChild(pathDiv);
        }
        pathDiv.textContent = merged.localPath;
      }
    }

    const sizeBytes = merged.size || merged.totalSize || merged.fileSize || merged.bytes || 0;
    if (sizeCell) sizeCell.textContent = formatBytes(sizeBytes);

    if (pill) {
      pill.textContent = merged.state || 'â€”';
      pill.className = statusClass(merged.state);
    }

    if (isSelectMode) syncMaster();
    
    // Update file count
    if (fileCount) {
      fileCount.textContent = `(${fileMap.size} files)`;
    }
  }

  function handleSnapshot(d) {
    if (statusPill && d.status !== undefined) {
      statusPill.textContent = d.status || '';
      statusPill.className = 'pill ' + statusClass(d.status).split(' ').pop();
    }
    if (Array.isArray(d.files) && filesBody) {
      d.files.forEach(upsertRow);
    }
  }

  function handleDelta(d) {
    const typ = (d.type || '').toLowerCase();
    if (typ === 'state' || d.status !== undefined) {
      if (statusPill && d.status !== undefined) {
        statusPill.textContent = d.status || '';
        statusPill.className = 'pill ' + statusClass(d.status).split(' ').pop();
      }
    }
    if (typ === 'file' || d.fileId) {
      upsertRow(d);
    }
    if (Array.isArray(d.files)) {
      d.files.forEach(upsertRow);
    }
  }

  es.onmessage = (e) => {
    try {
      const d = JSON.parse(e.data || '{}');
      if (d && Array.isArray(d.files)) {
        handleSnapshot(d);
      } else {
        handleDelta(d);
      }
    } catch (_) {}
  };

  es.onerror = () => { /* browser auto-reconnects */ };

  // Select all / Clear all + master checkbox wiring
  if (isSelectMode) {
    const master = document.getElementById('masterCheck');
    const btnAll = document.getElementById('btnSelectAll');
    const btnClr = document.getElementById('btnClearAll');

    function getChecks() {
      return Array.from(document.querySelectorAll('tbody input[type="checkbox"][name="fileIds"]'));
    }
    function setAll(checked) {
      getChecks().forEach(cb => cb.checked = checked);
      syncMaster();
    }
    function syncMaster() {
      if (!master) return;
      const cbs = getChecks();
      if (cbs.length === 0) {
        master.checked = false;
        master.indeterminate = false;
        return;
      }
      const checked = cbs.filter(cb => cb.checked).length;
      master.checked = checked === cbs.length;
      master.indeterminate = checked > 0 && checked < cbs.length;
    }

    if (master) {
      master.addEventListener('change', () => setAll(master.checked));
    }
    if (btnAll) btnAll.addEventListener('click', () => setAll(true));
    if (btnClr) btnClr.addEventListener('click', () => setAll(false));

    if (filesBody) {
      filesBody.addEventListener('change', (e) => {
        if (e.target && e.target.matches('input[type="checkbox"][name="fileIds"]')) {
          syncMaster();
        }
      });
    }

    syncMaster();
  }
})();
</script>
{% endblock %}
