FROM python:3.12-slim

# Avoid Python buffering and bytecode
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# System deps (curl for healthcheck)
RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*

# Copy requirements first for layer cache
COPY requirements.txt ./requirements.txt
COPY frontend/requirements.txt ./frontend_requirements.txt
RUN pip install --no-cache-dir -r requirements.txt -r frontend_requirements.txt && pip install --no-cache-dir gunicorn==23.0.0

# Copy app module (needed for user_manager, models, etc.)
COPY app ./app
COPY alembic ./alembic
COPY alembic.ini ./alembic.ini

# Copy frontend
COPY frontend/app.py ./frontend/app.py
COPY frontend/templates ./frontend/templates

EXPOSE 5000

# Healthcheck: confirm frontend is up
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD curl -fsS http://localhost:5000/debug/config || exit 1

# Run with gunicorn - optimized for video streaming
# Increased workers/threads to handle concurrent Range requests during seeking
# --worker-tmp-dir /dev/shm uses shared memory for better performance
CMD ["python","-m","gunicorn","--worker-class","gthread","-b","0.0.0.0:5000","--workers","4","--threads","8","--worker-tmp-dir","/dev/shm","--timeout","3600","--graceful-timeout","30","--keep-alive","65","--max-requests","5000","--max-requests-jitter","500","--access-logfile","-","--error-logfile","-","frontend.app:app"]
