# ----------------------------------------------------
# HTTP → HTTPS Redirect
# ----------------------------------------------------
server {
    listen 80;
    server_name <domain>;
    return 301 https://$host$request_uri;
}

# ----------------------------------------------------
# HTTPS Server
# ----------------------------------------------------
server {
    listen 443 ssl http2;
    server_name <domain>;

    # SSL (Certbot)
    ssl_certificate /etc/letsencrypt/live/<domain>/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/<domain>/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # Large files
    client_max_body_size 0;
    client_body_timeout 300s;
    send_timeout 300s;

    # Streaming performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    aio threads;
    directio 512k;

    # ------------------------------------------------
    # API → Port 9731 (SSE optimized)
    # ------------------------------------------------
    location /api/ {
        proxy_pass http://127.0.0.1:9731/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # SSE / long-lived connection settings
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_set_header Connection '';
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_set_header Accept-Encoding "";
    }

    # ------------------------------------------------
    # File / Video Streaming → Port 9732
    # ------------------------------------------------
    location / {
        # CORS + streaming headers
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, If-Range" always;
        add_header Accept-Ranges bytes always;

        # Handle OPTIONS cleanly
        if ($request_method = OPTIONS) {
            return 204;
        }

        proxy_pass http://127.0.0.1:9732;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # Range requests for video seeking
        proxy_set_header Range $http_range;
        proxy_set_header If-Range $http_if_range;
        
        # Pass through caching headers
        proxy_pass_header ETag;
        proxy_pass_header Last-Modified;
        proxy_pass_header Cache-Control;

        # Disable buffering for large streams
        proxy_buffering off;
        proxy_request_buffering off;

        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        
        # Ignore client abort for better streaming stability
        proxy_ignore_client_abort on;
    }
}
